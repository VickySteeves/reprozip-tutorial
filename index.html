<!DOCTYPE html>
<html>
    <head>
        <script src="js/jquery-1.7.2.min.js"></script>
        <script src="js/jquery.terminal-0.9.3.min.js"></script>
        <script src="js/jquery.mousewheel.min.js"></script>
        <link href="css/jquery.terminal-0.9.3.css" rel="stylesheet" />
    </head>
    <body>
        <!-- https://github.com/jcubic/jquery.terminal -->
        <div id="term_tutorial" class="terminal" style="height: 200px;"></div>
        <script>
var READTHEDOCS_VERSION = '1.0.x';

function join_path(a, b) {
    var path;
    b = b || '';
    if(b.length > 0 && b[0] === '/') {
        path = b;
    } else {
        path = a + "/" + b;
    }
    src = path.split('/');
    target = [];
    for(i = 0; i < src.length; ++i) {
        comp = src[i];
        if(comp === '..') {
            target.pop();
        } else if(comp !== '' && comp !== '.') {
            target.push(comp);
        }
    }
    return '/' + target.join('/');
}

function get_file(path) {
    if(path in env.directories) {
        return env.directories[path];
    } else if(path in env.files) {
        return env.files[path];
    } else {
        return null;
    }
}

function move_file(src, target, target_is_dir, is_move, tool_name, error) {
    if(src === '/' || src === '/home' || src === '/home/user') {
        error(tool_name + ": can't move " + src);
        return;
    }
    if(!/^\/home\/user(\/|$)/.test(target)) {
        error(tool_name + ": can't move to " + target);
        return;
    }
    var src_comp = src.split('/');
    var src_parent = '/' + src_comp.slice(0, -1).join('/');
    var target_comp = target.split('/');

    var target_parent = null, target_name = null;
    var target_parent_ent = null;
    var target_ent = get_file(target);
    if(target_ent === null || target_ent.type === 'file') {
        if(target_is_dir) {
            error(tool_name + ": " + target + ": not a directory");
            return;
        }
        target_parent = '/' + target_comp.slice(0, -1).join('/');
        target_name = target_comp[target_comp.length - 1];
        target_parent_ent = get_file(target_parent);
        if(target_parent_ent === null || target_parent_ent.type !== 'directory') {
            error(tool_name + ": " + target + ": not a directory");
            return;
        }
    } else if(target_ent.type === 'directory') {
        target_parent = target;
        target_parent_ent = target_ent;
        target_name = src_comp[src_comp.length - 1];
    }

    src_ent = get_file(src);
    if(src_ent === null) {
        error(tool_name + ": " + src + ": no such file or directory");
        return;
    }

    if(src_ent.type === 'file') {
        target_parent_ent.files[target_name] = true;
    } else {
        target_parent_ent.directories[target_name] = true;
    }
    if(is_move) {
        src_parent_ent = get_file(src_parent);
        var src_name = src_comp[src_comp.length - 1];
        if(src_ent.type === 'file') {
            src_parent_ent.files[src_name] = undefined;
        } else {
            src_parent_ent.directories[src_name] = undefined;
        }
    }
}

function copy_or_move(is_move, tool_name) {
    return function() {
        if(arguments.length < 2) {
            this.error("cp: needs two arguments");
            return;
        }
        for(var i = 0; i < arguments.length; ++i) {
            if(arguments[i].length === 0) {
                this.error(tool_name + ": empty argument");
                return;
            }
        }
        var target_is_dir = arguments.length > 2;
        var target = join_path(env.path, arguments[arguments.length - 1]);
        for(var i = 0; i < arguments.length - 1; ++i) {
            var arg = join_path(env.path, arguments[i]);
            move_file(arg, target, target_is_dir, is_move, tool_name,
                      this.error);
        }
    };
}

var env = new Object();
env.path = '/home/user';
env.directories = {
    '/': {
        directories: {'home': true},
        files: {}},
    '/home': {
        directories: {'user': true},
        files: {}},
    '/home/user': {
        directories: {},
        files: {'experiment.py': true}}
};
for(k in env.directories) {
    env.directories[k].type = 'directory';
}
env.files = {
    '/home/user/experiment.py': {what: 'experiment'}
};
for(k in env.files) {
    env.files[k].type = 'file';
}

jQuery(function($, undefined) {
    $('#term_tutorial').terminal({
        // Fake/replaced commands
        //
        help: function() {
            this.echo(
                "This JavaScript shell only supports a limited set of commands.",
                {
                    finalize: function(div) {
                        div.append("\nIf you want to install ReproZip on your own machine, type install or <a href=\"https://reprozip.readthedocs.org/en/" + READTHEDOCS_VERSION + "/install.html\" target=\"_blank\">click here</a>!");
                    }
                });
        },
        install: function() {
            this.echo("Opening installation instructions in new window...");
            window.open('https://reprozip.readthedocs.org/en/' + READTHEDOCS_VERSION + '/install.html', '_blank');
        },
        write: function() {
            this.echo("Taking you to our Gitter chatroom...");
            window.open('https://gitter.im/ViDA-NYU/reprozip', '_blank');
        },
        mail: function() {
            this.echo("Don't hesitate to use our mailing-list: reprozip-users@vgc.poly.edu");
            window.open('http://vgc.poly.edu/mailman/listinfo/reprozip-users', '_blank');
        },

        // Simple commands
        //
        pwd: function() {
            this.echo(env.path);
        },
        echo: function() {
            this.echo($.makeArray(arguments).join(' '));
        },
        cd: function(wd) {
            if(arguments.length !== 1) {
                this.error("cd: too many arguments");
                return;
            }
            var path = join_path(env.path, wd);
            if(path === '/' || path === '/home' || path === '/home/user/') {
                env.path = wd;
            }
            this.error("cd: " + path + ": not something we can move to");
        },
        ls: function() {
            var path = null;
            for(var i = 0; i < arguments.length; ++i) {
                var arg = arguments[i];
                if(arg.length === 0) {
                    this.error("ls: empty argument");
                    return;
                } else if(arg[0] != '-') {
                    if(path === null) {
                        path = arg;
                    } else {
                        this.error("ls: too many arguments");
                        return;
                    }
                }
            }
            var patharg = '.';
            if(path !== null) {
                patharg = path;
                path = join_path(env.path, path);
            } else {
                path = env.path;
            }
            var ent = get_file(path);
            if(ent === null) {
                this.error("ls: " + patharg + ": no such file or directory");
            } else if(ent.type === 'file') {
                this.echo(patharg);
            } else if(ent.type === 'directory') {
                this.echo($.extend([], Object.keys(ent.directories), Object.keys(ent.files)).join('\t'));
            }
        },

        // File commands
        //
        cat: function() {
            if(arguments.length === 0) {
                this.error("cat: need at least one filename");
                return;
            }
            for(var i = 0; i < arguments.length; ++i) {
                var arg = arguments[i];
                if(arg.length === 0) {
                    this.error("cat: empty argument");
                    return;
                }
                var ent = get_file(join_path(env.path, arguments[i]));
                if(ent === null) {
                    this.error("cat: " + arg + ": no such file or directory");
                    return;
                } else if(ent.type === 'directory') {
                    this.error("cat: " + arg + ": is a directory");
                    return;
                } else if(ent.type === 'file') {
                    if(ent.what === 'experiment') {
                        this.echo("#!/usr/bin/env python\n\nprint(\"Hello, world!\")")
                    }
                }
            }
        },
        cp: copy_or_move(false, "cp"),
        mv: copy_or_move(true, "mv"),
        rm: null,

        // ReproZip
        //
        reprozip: null,
        reprounzip: null,
    }, {
        greetings: "Press enter to submit commands",
        name: 'tutorial_term',
        height: 200,
        checkArity: false,
        prompt: '> '
    });
});
        </script>
    </body>
</html>
